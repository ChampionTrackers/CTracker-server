version: '3.9'

services:

  # db:
  #   image: postgres:alpine
  #   # restart: always
  #   # set shared memory limit when using docker-compose
  #   shm_size: 128mb
  #   # or set shared memory limit when deploy via swarm stack
  #   #volumes:
  #   #  - type: tmpfs
  #   #    target: /dev/shm
  #   #    tmpfs:
  #   #      size: 134217728 # 128*2^20 bytes = 128Mb
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #     POSTGRES_DB: ctracker
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"

  # adminer:
  #   image: adminer
  #   # restart: always
  #   ports:
  #     - 3030:8080
  #   depends_on: 
  #     - db

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    # restart: on-failure
    env_file:
      - stack.env
    volumes:
      - .:/usr/src/app
    # depends_on:
    #   - db
    ports:
      - '3333:3333'
    networks:
      - docker_proxy
    command: >
      sh -c "
      npm install &&
      npm run db:deploy &&
      npm run build &&
      npm run start
      "

networks:
  docker_proxy:
    external: true

# volumes:
#   postgres_data:
  
